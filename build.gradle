plugins {
    id 'com.github.johnrengelman.shadow' version '8.1.1' apply false
}

import org.gradle.api.attributes.java.TargetJvmVersion

def revisionValue = (findProperty('revision') ?: '0.3.19').toString()

def versions = [
    paperApi: '1.21.7-R0.1-SNAPSHOT',
    lombok: '1.18.34',
    devtools: (findProperty('devtoolsVersion') ?: '0.1.7-SNAPSHOT').toString(),
    authlib: '4.0.43',
    commandApi: '11.0.0',
    brigadier: '1.1.8',
    nettyTransport: '4.1.82.Final',
    commonsIo: '2.15.1'
]

def useJava = { Project p, int toolchainVersion, int releaseVersion ->
    p.java {
        toolchain {
            languageVersion = JavaLanguageVersion.of(toolchainVersion)
        }
        // Keep dependency resolution aligned with toolchain; bytecode level is controlled by --release.
        sourceCompatibility = JavaVersion.toVersion(toolchainVersion)
        targetCompatibility = JavaVersion.toVersion(toolchainVersion)
    }
    p.tasks.withType(JavaCompile).configureEach {
        options.release = releaseVersion
    }
}

def configureNms = { Project p, Map cfg ->
    def toolchainVersion = (cfg.toolchainVersion ?: cfg.javaVersion) as int
    useJava(p, toolchainVersion, cfg.javaVersion as int)
    p.dependencies {
        compileOnly "com.github.tanyaofei.devtools:devtools-core:${versions.devtools}"
        if (cfg.coreProvided) {
            compileOnly project(':fakeplayer-core')
        } else {
            implementation project(':fakeplayer-core')
        }
        compileOnly project(':fakeplayer-api')
        if (cfg.dependsOn) {
            def depProject = project(cfg.dependsOn)
            if (cfg.transitive == false) {
                compileOnly(depProject) { transitive = false }
            } else {
                compileOnly depProject
            }
        }

        def mcVersion = cfg.nmsVersion.toString().split('-R')[0]
        def spigotCandidates = [
            "${rootDir}/lib/spigot-${cfg.nmsVersion}-remapped-mojang.jar",
            "${rootDir}/lib/spigot-${mcVersion}-remapped-mojang.jar",
            "${rootDir}/lib/spigot-${cfg.nmsVersion}.jar",
            "${rootDir}/lib/spigot-${mcVersion}.jar"
        ]
        def spigotJar = spigotCandidates.collect { file(it) }.find { it.exists() }
        if (spigotJar != null) {
            compileOnly files(spigotJar)
        } else {
            compileOnly("org.spigotmc:spigot:${cfg.nmsVersion}:remapped-mojang") {
                exclude group: 'org.spigotmc', module: 'spigot-api'
            }
        }

        if (cfg.lombok) {
            compileOnly "org.projectlombok:lombok:${versions.lombok}"
            annotationProcessor "org.projectlombok:lombok:${versions.lombok}"
        }
    }
}

allprojects {
    group = 'io.github.hello09x.fakeplayer'
    version = revisionValue

    repositories {
        flatDir { dirs "${rootDir}/lib" }
        maven { url 'https://libraries.minecraft.net/' }
        maven { url 'https://hub.spigotmc.org/nexus/content/repositories/snapshots/' }
        maven { url 'https://hub.spigotmc.org/nexus/content/repositories/releases/' }
        maven { url 'https://maven.elmakers.com/repository/' }
        maven { url 'https://repo.extendedclip.com/content/repositories/placeholderapi/' }
        maven { url 'https://repo.papermc.io/repository/maven-public/' }
        maven { url 'https://oss.sonatype.org/content/groups/public/' }
        maven { url 'https://repo.dmulloy2.net/repository/public/' }
        maven { url 'https://jitpack.io' }
        mavenCentral()
    }

    dependencies {
        components {
            withModule('org.spigotmc:spigot') {
                allVariants {
                    withCapabilities {
                        removeCapability('org.spigotmc', 'spigot-api')
                    }
                }
            }
        }
    }
}

subprojects {
    apply plugin: 'java-library'

    tasks.withType(JavaCompile).configureEach {
        options.encoding = 'UTF-8'
    }

    configurations.configureEach {
        attributes.attribute(TargetJvmVersion.TARGET_JVM_VERSION_ATTRIBUTE, 21)
    }

    dependencies {
        compileOnly "org.jetbrains:annotations:24.1.0"
    }
}

project(':fakeplayer-api') {
    useJava(project, 21, 17)

    dependencies {
        compileOnly "io.papermc.paper:paper-api:${versions.paperApi}"
        compileOnly "org.projectlombok:lombok:${versions.lombok}"
        annotationProcessor "org.projectlombok:lombok:${versions.lombok}"
    }
}

project(':fakeplayer-core') {
    useJava(project, 21, 17)

    dependencies {
        compileOnly "io.papermc.paper:paper-api:${versions.paperApi}"
        compileOnly "org.projectlombok:lombok:${versions.lombok}"
        annotationProcessor "org.projectlombok:lombok:${versions.lombok}"

        compileOnly project(':fakeplayer-api')

        implementation "com.github.tanyaofei.devtools:devtools-core:${versions.devtools}"
        implementation "com.github.tanyaofei.devtools:devtools-command:${versions.devtools}"
        implementation "com.github.tanyaofei.devtools:devtools-database:${versions.devtools}"

        compileOnly "com.mojang:authlib:${versions.authlib}"
        compileOnly "dev.jorel:commandapi-paper-core:${versions.commandApi}"
        compileOnly "com.mojang:brigadier:${versions.brigadier}"
        compileOnly "io.netty:netty-transport:${versions.nettyTransport}"
        compileOnly "commons-io:commons-io:${versions.commonsIo}"

        compileOnly "com.github.jikoo:OpenInv:5.3.0"
        compileOnly "me.clip:placeholderapi:2.11.7"
    }

    tasks.processResources {
        filteringCharset = 'UTF-8'
        filesMatching('plugin.yml') {
            expand(revision: project.version)
        }
    }
}

project(':fakeplayer-dist') {
    apply plugin: 'com.github.johnrengelman.shadow'

    useJava(project, 21, 21)

    dependencies {
        implementation project(':fakeplayer-core')
        implementation project(':fakeplayer-api')
        implementation project(':fakeplayer-v1_20_1')
        implementation project(':fakeplayer-v1_20_2')
        implementation project(':fakeplayer-v1_20_3')
        implementation project(':fakeplayer-v1_20_4')
        implementation project(':fakeplayer-v1_20_5')
        implementation project(':fakeplayer-v1_20_6')
        implementation project(':fakeplayer-v1_21')
        implementation project(':fakeplayer-v1_21_1')
        implementation project(':fakeplayer-v1_21_3')
        implementation project(':fakeplayer-v1_21_4')
        implementation project(':fakeplayer-v1_21_5')
        implementation project(':fakeplayer-v1_21_6')
        implementation project(':fakeplayer-v1_21_7')
        implementation project(':fakeplayer-v1_21_8')
        implementation project(':fakeplayer-v1_21_9')
        implementation project(':fakeplayer-v1_21_10')
        implementation project(':fakeplayer-v1_21_11')
    }

    buildDir = file("${rootDir}/target")

    tasks.shadowJar {
        archiveBaseName = 'fakeplayer'
        archiveVersion = project.version.toString()
        archiveClassifier = ''
    }

    tasks.jar {
        enabled = false
    }

    tasks.build {
        dependsOn tasks.shadowJar
    }

    def serverVersions = [
        '1.20.1',
        '1.20.2',
        '1.20.6',
        '1.21',
        '1.21.1',
        '1.21.3',
        '1.21.4',
        '1.21.5',
        '1.21.6',
        '1.21.7',
        '1.21.8',
        '1.21.9',
        '1.21.10',
        '1.21.11'
    ]

    tasks.register('copyToServers') {
        dependsOn tasks.shadowJar
        doLast {
            def jarFile = tasks.shadowJar.archiveFile.get().asFile
            serverVersions.each { version ->
                def destFile = file("${rootDir}/server-${version}/plugins/fakeplayer.jar")
                destFile.parentFile.mkdirs()
                copy {
                    from jarFile
                    into destFile.parentFile
                    rename { 'fakeplayer.jar' }
                }
            }
        }
    }
}

configureNms(project(':fakeplayer-v1_20_1'), [
    javaVersion: 17,
    toolchainVersion: 21,
    nmsVersion: '1.20.1-R0.1-SNAPSHOT',
    lombok: true,
    coreProvided: false
])

configureNms(project(':fakeplayer-v1_20_2'), [
    javaVersion: 17,
    toolchainVersion: 21,
    nmsVersion: '1.20.2-R0.1-SNAPSHOT',
    lombok: true,
    coreProvided: true
])

configureNms(project(':fakeplayer-v1_20_3'), [
    javaVersion: 17,
    toolchainVersion: 21,
    nmsVersion: '1.20.4-R0.1-SNAPSHOT',
    lombok: false,
    coreProvided: true,
    dependsOn: ':fakeplayer-v1_20_4'
])

configureNms(project(':fakeplayer-v1_20_4'), [
    javaVersion: 17,
    toolchainVersion: 21,
    nmsVersion: '1.20.4-R0.1-SNAPSHOT',
    lombok: true,
    coreProvided: true
])

configureNms(project(':fakeplayer-v1_20_5'), [
    javaVersion: 17,
    toolchainVersion: 21,
    nmsVersion: '1.20.6-R0.1-SNAPSHOT',
    lombok: false,
    coreProvided: true,
    dependsOn: ':fakeplayer-v1_20_6'
])

configureNms(project(':fakeplayer-v1_20_6'), [
    javaVersion: 17,
    toolchainVersion: 21,
    nmsVersion: '1.20.6-R0.1-SNAPSHOT',
    lombok: true,
    coreProvided: true
])

configureNms(project(':fakeplayer-v1_21'), [
    javaVersion: 21,
    nmsVersion: '1.21-R0.1-SNAPSHOT',
    lombok: true,
    coreProvided: true
])

configureNms(project(':fakeplayer-v1_21_1'), [
    javaVersion: 21,
    nmsVersion: '1.21.1-R0.1-SNAPSHOT',
    lombok: false,
    coreProvided: true,
    dependsOn: ':fakeplayer-v1_21',
    transitive: false
])

configureNms(project(':fakeplayer-v1_21_3'), [
    javaVersion: 21,
    nmsVersion: '1.21.3-R0.1-SNAPSHOT',
    lombok: true,
    coreProvided: true
])

configureNms(project(':fakeplayer-v1_21_4'), [
    javaVersion: 21,
    nmsVersion: '1.21.4-R0.1-SNAPSHOT',
    lombok: true,
    coreProvided: true
])

configureNms(project(':fakeplayer-v1_21_5'), [
    javaVersion: 21,
    nmsVersion: '1.21.5-R0.1-SNAPSHOT',
    lombok: true,
    coreProvided: true
])

configureNms(project(':fakeplayer-v1_21_6'), [
    javaVersion: 21,
    nmsVersion: '1.21.6-R0.1-SNAPSHOT',
    lombok: true,
    coreProvided: true
])

configureNms(project(':fakeplayer-v1_21_7'), [
    javaVersion: 21,
    nmsVersion: '1.21.7-R0.1-SNAPSHOT',
    lombok: false,
    coreProvided: true,
    dependsOn: ':fakeplayer-v1_21_6',
    transitive: false
])

configureNms(project(':fakeplayer-v1_21_8'), [
    javaVersion: 21,
    nmsVersion: '1.21.8-R0.1-SNAPSHOT',
    lombok: false,
    coreProvided: true,
    dependsOn: ':fakeplayer-v1_21_6',
    transitive: false
])

configureNms(project(':fakeplayer-v1_21_9'), [
    javaVersion: 21,
    nmsVersion: '1.21.10-R0.1-SNAPSHOT',
    lombok: true,
    coreProvided: true
])

configureNms(project(':fakeplayer-v1_21_10'), [
    javaVersion: 21,
    nmsVersion: '1.21.10-R0.1-SNAPSHOT',
    lombok: false,
    coreProvided: true,
    dependsOn: ':fakeplayer-v1_21_9',
    transitive: false
])

configureNms(project(':fakeplayer-v1_21_11'), [
    javaVersion: 21,
    nmsVersion: '1.21.11-R0.1-SNAPSHOT',
    lombok: false,
    coreProvided: true,
    dependsOn: ':fakeplayer-v1_21_9',
    transitive: false
])
